{% extends "layout.html" %}
{% block body %}
<style type="text/css">
    #svgWrapper {
        display: inline-block;
    }
    #panelWrapper {
        width: 200px;
        border: solid #808080 1px;
        padding: 10px;
        display: inline-block;
    }
    .separator {
        margin-bottom: 10px;
        height: 1px;
        background-color: #808080;
    }
</style>

<div>
    <div id="svgWrapper">
        <svg width="800", height="400"></svg>
    </div>
    <div id="panelWrapper">
        <div>
            <p> Stratified Sampling </p>
            <div class="separator"></div>
            <p> <b>Step 1.</b> Group cases by color into 4 stratum:
                <button id="button_strata" type="button" class="btn btn-primary btn-xs"> Stratify </button>
            </p>
            <p> <b>Step 2.</b> Randomly sample 6 cases from each selected stratum, collecting a total of 24 cases:
                <button id="button_resample" type="button" class="btn btn-primary btn-xs disabled"> Sample </button>
            </p>
            <div class="separator"></div>
            <button id="button_reset" class="btn btn-primary btn-xs disabled"> Reset </button>
        </div>
    </div>
</div>

<script type="text/javascript">

    var reset_action = function(){
        var svg = d3.select("svg");
        generate_data();
        svg.selectAll("circle").remove();
        svg.selectAll("text").remove();

        var circles = svg.selectAll("circle")
        .data(dataPoints)
        .enter()
        .append("circle");

        circles.attr("cx", function(d, i) {
            return d["rand_cx"]; })
        .attr("cy", function(d, i) {
            return d["rand_cy"]; })
        .attr("r", function(d, i){
           return d["r"]; })
        .attr("class", function(d, i){
           return d["class"]; })
        .attr("color_name", function(d, i){
          return d["color_name"]; })
        .style("fill", function(d, i){
           return d["color"];
       });
    };

    // buttons
    d3.select("#button_strata").on("click", function(){
        var svg = d3.select("svg");
        strataByColor(svg);
        d3.select("#button_strata").classed("disabled", true)
        d3.select("#button_resample").classed("disabled", false);
    });

    d3.select("#button_resample").on("click", function(){
        var svg = d3.select("svg");
        selectSamples(svg);
        d3.select("#button_resample").classed("disabled", true);
        d3.select("#button_reset").classed("disabled", false);
    });

    d3.select("#button_reset").on("click", function(){
        reset_action();
        d3.select("#button_reset").classed("disabled", true);
        d3.select("#button_strata").classed("disabled", false);
    });


    // SVG
    var svg = d3.select("svg")
    var svgViewBoxWidth = svg.attr("width")
    var svgViewBoxHeight = svg.attr("height")

    var svgViewBoxWidth = 800; //internal coordinate system for width, height
    var svgViewBoxHeight = 400;
    var svgWidth = (848 - 200); // actual width, height
    var svgHeight = (svgViewBoxHeight / svgViewBoxWidth) * (svgWidth)

    var svg = d3.select("svg")
        .attr("width", svgWidth)
        .attr("height", svgHeight)
        .attr("viewBox","0 0 " + svgViewBoxWidth + " " + svgViewBoxHeight);

    pointRadius = 3;
    strataRadius = 80;
    populationSize = 100;
    sampleSize = 24;

    var xScale = d3.scale.linear()
        .domain([0, svgViewBoxWidth])
        .range([pointRadius, svgViewBoxWidth - pointRadius]);

    var yScale = d3.scale.linear()
        .domain([0, svgViewBoxHeight])
        .range([pointRadius, svgViewBoxHeight - pointRadius]);

    // colors
    blue = "#569BBD";
    green = "#4C721D";
    black = "#000000";
    yellow = "#F4DC00";
    colors = [blue, green, black, yellow];
    colorNames = ["blue","green","black","yellow"];
    gray = "#808080";
    red = "#F05133";

    // generate data
    dataStratas = [];
    dataPoints = [];
    var generate_data = function(){

        dataStratas = [];
        dataPoints = [];

        // generate stratas
        for( var i = 0; i < colors.length; i++){
            strata = {
                "cx":  (i * ((svgViewBoxWidth) / colors.length) + strataRadius + 20),
                "cy": (svgViewBoxHeight/2),
                "r": strataRadius,
                "color": colors[i],
                "class": "strata_circle"
            };
            dataStratas.push(strata);
        }

        //generate points
        for(var i = 0; i < populationSize; i++){
            index = Math.floor(Math.random()*colors.length);
            strata = dataStratas[index]
            rand_angle = Math.random() * 2 * Math.PI;
            rand_radius = Math.random() * (strata["r"] - 5);
            point = {
                "rand_cx": xScale(Math.random() * svgViewBoxWidth),
                "rand_cy": yScale(Math.random() * svgViewBoxHeight),
                "strata_cx": rand_radius * Math.cos(rand_angle) + strata["cx"],
                "strata_cy": rand_radius * Math.sin(rand_angle) + strata["cy"],
                "color": colors[index],
                "color_name": colorNames[index],
                "r": pointRadius,
                "class": "point_circle"
            }
            dataPoints.push(point);
        }
    };

    // strata by color
    var strataByColor = function(svg){
        svg.selectAll(".selected_point_fill").remove();
        svg.selectAll(".selected_point_stroke").remove();

        svg.selectAll(".point_circle")
            .transition()
            .attr("cx", function(d, i) {
                return d["strata_cx"]; })
            .attr("cy", function(d, i) {
                return d["strata_cy"]; })

        var stratas = svg.selectAll(".strata_circle")
            .data(dataStratas)
            .enter()
            .append("circle")

        stratas.attr("cx", function(d, i){
                return d["cx"]; })
            .attr("cy", function(d, i){
                return d["cy"]; })
            .attr("r", function(d, i){
                return d["r"]; })
            .attr("class", function(d, i){
                return d["class"]; })
            .style("fill-opacity", 0)
            .style("stroke-width", 2)
            .style("stroke", gray);

        var text = svg.selectAll("text")
            .data(dataStratas)
        .enter().append("text")
            .text(function(d, i) {
                return "Strata " + (i + 1); })
            .attr("x", function(d, i){
                return d["cx"]; })
            .attr("y", function(d, i){
                return d["cy"] + d["r"] + 20; })
            .attr("font-family", "sans-serif")
            .attr("font-size", 15)
            .attr("fill", gray)
            .attr("text-anchor", "middle");
    };

    // sample from stratas
    var sample_without_replacement = function(arr, num_samples){
        samples = []
        for(i = 0; i < num_samples; i++){
            var index = Math.floor(Math.random()*arr.length);
            samples.push(arr.splice(index, 1)[0]);
        }
        return samples;
    }

    var selectSamples = function(svg){
        svg.selectAll(".selected_point_fill").remove();
        svg.selectAll(".selected_point_stroke").remove();

        for(var i = 0; i < colors.length; i++){
            var circles = svg.selectAll("[color_name=" + colorNames[i] + "]");
            var samples = sample_without_replacement(circles[0], sampleSize/colors.length);

            for(var j = 0; j < samples.length; j++){
                selected_point = d3.select(samples[j])

                svg.append("circle")
                    .attr("class", "selected_point_fill")
                    .attr("cx", selected_point.attr("cx"))
                    .attr("cy", selected_point.attr("cy"))
                    .attr("r",pointRadius)
                    .style("fill",red);

                svg.append("circle")
                    .attr("class", "selected_point_stroke")
                    .attr("cx", selected_point.attr("cx"))
                    .attr("cy", selected_point.attr("cy"))
                    .attr("r",pointRadius + 2)
                    .style("fill-opacity",0)
                    .style("stroke-width",1)
                    .style("stroke",red);
            }
        }
    };

    reset_action();

</script>

{% endblock %}
